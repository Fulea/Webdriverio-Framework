"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.limit = void 0;
const json_stringify_safe_1 = __importDefault(require("json-stringify-safe"));
const validator_1 = __importDefault(require("validator"));
const OBJLENGTH = 10;
const ARRLENGTH = 10;
const STRINGLIMIT = 1000;
const STRINGTRUNCATE = 200;
exports.limit = function (rawVal) {
    if (!rawVal)
        return rawVal;
    // Ensure we're working with a copy
    let val = JSON.parse(json_stringify_safe_1.default(rawVal));
    const type = Object.prototype.toString.call(val);
    if (type === '[object String]') {
        if (val.length > 100 && validator_1.default.isBase64(val)) {
            return `[base64] ${val.length} bytes`;
        }
        if (val.length > STRINGLIMIT) {
            return val.substr(0, STRINGTRUNCATE) + ` ... (${val.length - STRINGTRUNCATE} more bytes)`;
        }
        return val;
    }
    else if (type === '[object Array]') {
        const length = val.length;
        if (length > ARRLENGTH) {
            val = val.slice(0, ARRLENGTH);
            val.push(`(${length - ARRLENGTH} more items)`);
        }
        return val.map(exports.limit);
    }
    else if (type === '[object Object]') {
        const keys = Object.keys(val);
        const removed = [];
        for (let i = 0, l = keys.length; i < l; i++) {
            if (i < OBJLENGTH) {
                val[keys[i]] = exports.limit(val[keys[i]]);
            }
            else {
                delete val[keys[i]];
                removed.push(keys[i]);
            }
        }
        if (removed.length) {
            val._ = (keys.length - OBJLENGTH) + ' more keys: ' + JSON.stringify(removed);
        }
        return val;
    }
    return val;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsOEVBQTJDO0FBQzNDLDBEQUFpQztBQUVqQyxNQUFNLFNBQVMsR0FBRyxFQUFFLENBQUE7QUFDcEIsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFBO0FBQ3BCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQTtBQUN4QixNQUFNLGNBQWMsR0FBRyxHQUFHLENBQUE7QUFFYixRQUFBLEtBQUssR0FBRyxVQUFVLE1BQVk7SUFDdkMsSUFBSSxDQUFDLE1BQU07UUFBRSxPQUFPLE1BQU0sQ0FBQTtJQUUxQixtQ0FBbUM7SUFDbkMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyw2QkFBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7SUFDdkMsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRWhELElBQUksSUFBSSxLQUFLLGlCQUFpQixFQUFFO1FBQzVCLElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLElBQUksbUJBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDN0MsT0FBTyxZQUFZLEdBQUcsQ0FBQyxNQUFNLFFBQVEsQ0FBQTtTQUN4QztRQUVELElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxXQUFXLEVBQUU7WUFDMUIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxjQUFjLENBQUMsR0FBRyxTQUFTLEdBQUcsQ0FBQyxNQUFNLEdBQUcsY0FBYyxjQUFjLENBQUE7U0FDNUY7UUFFRCxPQUFPLEdBQUcsQ0FBQTtLQUNiO1NBQU0sSUFBSSxJQUFJLEtBQUssZ0JBQWdCLEVBQUU7UUFDbEMsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQTtRQUN6QixJQUFJLE1BQU0sR0FBRyxTQUFTLEVBQUU7WUFDcEIsR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFBO1lBQzdCLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxNQUFNLEdBQUcsU0FBUyxjQUFjLENBQUMsQ0FBQTtTQUNqRDtRQUNELE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxhQUFLLENBQUMsQ0FBQTtLQUN4QjtTQUFNLElBQUksSUFBSSxLQUFLLGlCQUFpQixFQUFFO1FBQ25DLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDN0IsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFBO1FBQ2xCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDekMsSUFBSSxDQUFDLEdBQUcsU0FBUyxFQUFFO2dCQUNmLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxhQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDckM7aUJBQU07Z0JBQ0gsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ25CLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDeEI7U0FDSjtRQUNELElBQUksT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNoQixHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsR0FBRyxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUMvRTtRQUNELE9BQU8sR0FBRyxDQUFBO0tBQ2I7SUFDRCxPQUFPLEdBQUcsQ0FBQTtBQUNkLENBQUMsQ0FBQSJ9